<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          IPC浅析 - Andfans
        
    </title>

    <link rel="canonical" href="http://andfanswzp.pw/2017/07/23/IPC浅析/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('http://i1.piimg.com/588926/14c9e94b1c44706b.png')
            /*post*/
        
    }
    
    #signature{
        background-image: url('/img/signature/BeanTechSign-white.png');
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Android" title="Android">Android</a>
                            
                              <a class="tag" href="/tags/#IPC" title="IPC">IPC</a>
                            
                        </div>
                        <h1>IPC浅析</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Andfans on
                            2017-07-23
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Andfans</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="概述">概述</h2>
<p>IPC：含义为进程间通信或者跨进程通信，是指两个进程之间进行数据交换的过程。</p>
<p>Windows中常见的IPC方式：剪切板、管道和邮槽</p>
<p>Linux中常见的IPC方式：命名管道、共享内容、信号量</p>
<p>Android中常见的IPC方式：Binder、AIDL、Messenger、ContentProvider、Socket、Bundle、文件等</p>
<h3 id="ipc的使用场景">IPC的使用场景</h3>
<ol>
<li>为了加大一个应用可以使用的内存空间</li>
<li>当前应用需要向其他应用获取数据</li>
</ol>
<h3 id="如何查看应用中的进程信息">如何查看应用中的进程信息？</h3>
<ol>
<li>借助于DDMS</li>
<li>使用shell命令：adb  shell  ps|grep 包名</li>
</ol>
<h3 id="进程名的指定方式">进程名的指定方式</h3>
<ol>
<li>android:process = “:进程名”：&quot;:&quot;的含义是指要在当前的进程名前附加上当前的包名，因此完整的进程名应该是包名:进程名，使用这种方式指定的进程是当前应用的私有进程，其他应用的组件不可以和它跑在同一个进程中</li>
<li>android:process = “进程名”：这种方式指定的进程属于全局进程，其他应用通过ShareUID的方式可以和它跑在同一个进程中(需要两个应用签名相同)。在这种情况下，它们可以互相访问对方的私有数据，比如:data目录、组件信息</li>
</ol>
<p>Android系统会为每个应用分配一个唯一的UID，具有相同UID的应用才能共享数据。</p>
<p>因为Android系统为每一个进程都会分配一个独立的虚拟机，不同的虚拟机在内存分配上有不同的地址空间，这就导致了在不同的虚拟机中访问同一个类的对象会产生多份副本，因此在使用多进程共享数据时会产生很多问题。</p>
<h3 id="使用多进程会造成的问题">使用多进程会造成的问题</h3>
<ol>
<li>静态成员和单例模式完全失效；</li>
<li>线程同步机制完全失效；</li>
<li>SharedPreferences的可靠性下降，SharedPreferences不支持两个进程同时去执行写操作，否则会导致一定几率的数据丢失，这是因为SharedPreferences底层是通过读/写XML文件来实现的，并发写显然是可能出问题的；</li>
<li>Application会多次创建，当一个组件跑在一个新的进程中的时候，由于系统要在创建新的进程的同时分配独立的虚拟机，所以这个过程其实就是启动一个应用的过程，所以会重复创建新的Application。</li>
</ol>
<p>总结来说：不同的进程会拥有不同的虚拟机，application，以及内存空间。</p>
<h2 id="serializable接口">Serializable接口</h2>
<p>是Java提供的一个序列化接口，它是一个空接口，为对象提供标准的序列化和反序列化操作。</p>
<h3 id="使用serializable来实现序列化">使用Serializable来实现序列化</h3>
<ol>
<li>让类实现Serializable接口</li>
<li>在类中声明中指定一个serialVersionUID标识</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> Javas;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.*;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *</div><div class="line"> * Created by Andfans on 2017/7/22.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSerializable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</div><div class="line">        User u1 = <span class="keyword">new</span> User(<span class="string">"aa"</span>,<span class="number">20</span>);</div><div class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"cache.txt"</span>));</div><div class="line">        oos.writeObject(u1);</div><div class="line">        oos.close();</div><div class="line">        </div><div class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"cache.txt"</span>));</div><div class="line">        User u2 = (User) ois.readObject();</div><div class="line">        ois.close();</div><div class="line">        System.out.println(u2.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</div><div class="line">    String name;</div><div class="line">    <span class="keyword">int</span> age;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.age = age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"name:"</span>+name+<span class="string">"  age:"</span>+age;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="serialversionuid的作用">serialVersionUID的作用</h3>
<p>serialVersionUID是用来辅助序列化和反序列化过程的，原则上序列化后的数据中的serialVersionUID只有和当前类的serialVersionUID相同时才能够正常的被反序列化。</p>
<p>serialVersionUID详细的工作机制：序列化的时候系统会把当前类的serialVersionUID写到序列化的载体中，当反序列化时，系统会去检测文件中的serialVersionUID，看它是否和当前类的serialVersionUID一致，如果一致就说明序列化的类的版本和当前类的版本相同，这个时候可以成功反序列化；否则就说明当前类和序列化的类相比发生了某种变换，比如变量的数量、类型可能发生了改变，这个时候无法正常反序列化（抛出InvalidClassException异常）。</p>
<p>由上述说明可知，用户自定义serialVersionUID会提高反序列化成功的可能性(如果不自定义，系统会自动计算当前类hash值作为serialVersionUID，而且每次类发生改变，系统就会重新计算该值)。</p>
<p>静态成员属于类不属于对象，所以不会参与序列化的过程，使用transient关键字标记的成员变量不参与序列化的过程。</p>
<p>通过实现writeObject()和readObject()方法可以改变系统默认的序列化过程。</p>
<h2 id="parcelable接口">Parcelable接口</h2>
<p>让类实现Parcelable接口中的所有方法就可以实现序列化。</p>
<h3 id="parcelable接口方法解释">Parcelable接口方法解释</h3>
<ul>
<li>createFromParcel(Parcel in)：从序列化后的对象中创建原始对象</li>
<li>newArray(int size)：创建指定长度的原始对象数组</li>
<li>User(Parcel in)：从序列化后的对象中创建原始对象</li>
<li>writeToParcel(Parcel out,int flags)：将当前对象写入序列化结构中，flags=1时表示当前对象需要作为返回值返回，不能立即释放资源，几乎所有情况都为0</li>
<li>describeContents：返回当前对象的内容描述，如果含有文件描述符，返回1，否则返回0，几乎所有情况都返回0</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParcelData</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> userId;</div><div class="line">    User user;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParcelData</span><span class="params">(<span class="keyword">int</span> userId, User user)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.userId = userId;</div><div class="line">        <span class="keyword">this</span>.user = user;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//通过调用类的反序列化构造方法来实现原始对象/对象数组的创建</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Creator&lt;ParcelData&gt; CREATOR = <span class="keyword">new</span> Creator&lt;ParcelData&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> ParcelData <span class="title">createFromParcel</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ParcelData(in);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> ParcelData[] newArray(<span class="keyword">int</span> size) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ParcelData[size];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">//反序列化</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ParcelData</span><span class="params">(Parcel in)</span> </span>&#123;</div><div class="line">        userId = in.readInt();</div><div class="line">        <span class="comment">//由于book是另外一个可序列化对象，所以它的反序列化过程需要传递当前线程的上下文类加载器，否则会报无法找到类的错误</span></div><div class="line">        user = in.readParcelable(Thread.currentThread().getContextClassLoader());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//序列化</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel dest, <span class="keyword">int</span> flags)</span> </span>&#123;</div><div class="line">        dest.writeInt(userId);</div><div class="line">        dest.writeParcelable(user,<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="parcelable和serializable的区别">Parcelable和Serializable的区别</h2>
<ul>
<li>Serializable使用简单，但是开销很大，序列化和反序列化过程中需要大量I/O操作，适用于将对象序列化到存储设备中或者将对象序列化后通过网络传输。</li>
<li>Parcelable是Android中的序列化方式，更适合用在Android平台上，效率高，缺点是使用麻烦，主要用在内存序列化上。</li>
</ul>
<h2 id="binder">Binder</h2>
<p>Binder牵涉内容较多，将专门写一篇博客来介绍，敬请期待。</p>
<h2 id="android中ipc的实现方式">Android中IPC的实现方式</h2>
<h3 id="使用bundle">使用Bundle</h3>
<p>Android中的三大组件(Activity、Service、BroadcastReceiver)都是支持在Intent中传递Bundle数据的，因为Bundle实现了Parcelable接口，所以它可以方便地在不同进程间传输，这种方式比较简单，在此就不详细说明了，下面介绍一个特殊的使用场景。</p>
<p><strong>场景：A进程正在进行一个计算，计算完成后它要启动B进程的一个组件并把计算结果传递给B进程，不巧的是这个计算结果不支持放入Bundle中，因此无法通过Intent来传输，这个时候用其他的IPC方式可能略显复杂，那该怎么办呢？</strong></p>
<p>方法：先通过Intent启动进程B的一个Service组件(比如IntentService)，让Service在后台进行计算，计算完毕后再启动B进程中的真正要启动的目标组件，由于Service也运行在B进程中，所以目标组件就可以直接获取计算结果，这样一来就轻松解决了跨进程的问题。</p>
<h3 id="使用文件共享">使用文件共享</h3>
<p>由于Android系统基于Linux，使得并发读/写文件可以没有限制的进行，通过文件交换数据，除了可以交换一些文本信息外，我们还可以在一个进程中序列化一个对象到文件系统中的同时从另一个进程中恢复这个对象。通过文件共享这种方式来共享数据对文件格式没有具体要求，既可以是文本文件，也可以是XML文件。</p>
<h4 id="缺陷">缺陷</h4>
<p>在并发读/写时，我们读出的文件内容可能不是最新的，如果是并发写，后果更严重，可能会导致数据的丢失，因此需要使用线程同步来限制这种并发写操作。</p>
<p>SharedPreferences也是文件的一种，它通过键值对来存储数据，在底层实现上它采用XML文件来存储键值对，系统对这种文件的读写具有一定的缓存策略，即在内存中会有一份SharedPreferences文件的缓存，因此在多进程模式下，系统对它的读/写就会变得非常不可靠，因此不建议在进程间通信时使用。</p>
<p>综上所述，文件共享方式适合在对数据同步要求不高的进程之间进行通信。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIPC</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Context context;</div><div class="line">    <span class="keyword">private</span> TextView textView;</div><div class="line">    <span class="keyword">private</span> Button btFile;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_PATH = Environment.getExternalStorageDirectory().getAbsolutePath()+<span class="string">"/Test/file.txt"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.run();</div><div class="line">            User user = <span class="keyword">new</span> User(<span class="number">22</span>,<span class="string">"fileValue"</span>,<span class="keyword">true</span>);</div><div class="line">            File file = <span class="keyword">new</span> File(TestIPC.FILE_PATH);</div><div class="line">          	<span class="comment">//序列化一个对象到文件中</span></div><div class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</div><div class="line">                objectOutputStream.writeObject(user);</div><div class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(context,TestIpcFile.class);</div><div class="line">            context.startActivity(intent);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.ipc_test_layout);</div><div class="line">        context = <span class="keyword">this</span>;</div><div class="line">        textView = (TextView) findViewById(R.id.id_activity_ipc_response);</div><div class="line">        btFile = (Button) findViewById(R.id.id_activity_ipc_file);</div><div class="line">        btFile.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                Thread t = <span class="keyword">new</span> MyThread();</div><div class="line">                t.start();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIpcFile</span> <span class="keyword">extends</span> <span class="title">Activity</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> TextView tvGet;</div><div class="line">    <span class="keyword">static</span> User user;</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.run();</div><div class="line">            File file = <span class="keyword">new</span> File(TestIPC.FILE_PATH);</div><div class="line">            ObjectInputStream objectInputStream = <span class="keyword">null</span>;</div><div class="line">            Log.e(<span class="string">"File"</span>,<span class="string">"begin"</span>);</div><div class="line">            <span class="keyword">if</span>(file.exists())&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                  	<span class="comment">//从文件中反序列化出一个对象</span></div><div class="line">                    objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</div><div class="line">                    user = (User) objectInputStream.readObject();</div><div class="line">                    tvGet.setText(user.toString());</div><div class="line">                &#125;<span class="keyword">catch</span> (IOException | ClassNotFoundException e)&#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;<span class="keyword">else</span> &#123;</div><div class="line">                Log.e(<span class="string">"File"</span>,<span class="string">"NO find"</span>);</div><div class="line">            &#125;</div><div class="line">            Log.e(<span class="string">"File"</span>,<span class="string">"end"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.file_test_layout);</div><div class="line">        tvGet = (TextView) findViewById(R.id.id_activity_file_tv01);</div><div class="line">        <span class="keyword">new</span> MyThread().start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="使用messenger">使用Messenger</h3>
<p>使用Messenger可以在不同的进程中传递Message对象，因此我们可以将要跨进程传输的数据放入Message中，这是一种轻量级的IPC方案，它的底层实现是AIDL，它对AIDL做了封装，使得我们用起来更加简单，同时，由于它一次只处理一个请求，因此在服务端我们不用考虑线程同步的问题，因为服务端不存在并发执行的情形。</p>
<h4 id="实现messenger的步骤">实现Messenger的步骤</h4>
<ul>
<li>服务端进程
<ul>
<li>首先创建一个Service来处理客户端的连接请求</li>
<li>然后创建一个Handler(这个Handler用于处理从客户端发送来的消息)，并通过这个Handler来创建一个Messenger(这个Messenger用来从客户端向服务端发送消息)对象</li>
<li>最后在Service的onBind中返回这个Messenger对象底层的Binder给客户端</li>
</ul>
</li>
<li>客户端进程
<ul>
<li>首先绑定服务端的Service，绑定成功后使用服务端返回的IBinder对象创建一个Messenger</li>
<li>使用这个Messenger对象向服务端发送消息</li>
<li>创建一个Handler(这个Handler用于处理从服务端发来的反馈信息)，并通过Handler来创建一个Messenger(这个Messenger对象用于从服务端向客户端反馈消息)对象</li>
<li>将上一步创建的Messenger对象使用第一步中的Messenger对象发送给服务端(通过Message的replyTo参数承载)</li>
</ul>
</li>
</ul>
<p>服务端(解释都在注释里)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">  <span class="comment">//这个Handler用于处理从客户端发来的消息(此处是User对象)</span></div><div class="line">  <span class="keyword">private</span> Handler messengerHandler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what)&#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">11</span>:</div><div class="line">                	<span class="comment">//取出客户端发来的数据</span></div><div class="line">                    Bundle bundle = msg.getData();</div><div class="line">                        <span class="comment">/*</span></div><div class="line">                        我们应用中存在两种类加载器它们分别是BootClassLoader和PathClassLoader.</div><div class="line">                        BootClassLoader用来加载系统类,PathClassLoader用来加载我们在应用中自己写的类.</div><div class="line">                        所以当类加载器为BootClassLoader时我们要加载自己写的类就会出现ClassNotFound异常.</div><div class="line">                        下面这句话就是将加载器指定为PathClassLoader</div><div class="line">                        */</div><div class="line">                    bundle.setClassLoader(User.class.getClassLoader());</div><div class="line">                    User user = (User) bundle.get(<span class="string">"user"</span>);</div><div class="line">                    Log.e(<span class="string">"Messenger"</span>,user.toString());</div><div class="line">                	<span class="comment">//拿到用来给客户端反馈的Messenger</span></div><div class="line">                    Messenger messenger = msg.replyTo;</div><div class="line">                    Message reply = Message.obtain(<span class="keyword">null</span>,<span class="number">2</span>);</div><div class="line">                    Bundle replyData = <span class="keyword">new</span> Bundle();</div><div class="line">                    replyData.putParcelable(<span class="string">"reply"</span>,<span class="keyword">new</span> User(<span class="number">22</span>,<span class="string">"我已经收到你的消息"</span>,<span class="keyword">true</span>));</div><div class="line">                    reply.setData(replyData);</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                      <span class="comment">//向客户端发送反馈数据</span></div><div class="line">                        messenger.send(reply);</div><div class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:<span class="keyword">super</span>.handleMessage(msg);<span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">  	<span class="comment">//这个Messenger用于传递给客户端，让客户端利用这个Messenger来向服务端发送消息</span></div><div class="line">    <span class="keyword">private</span> Messenger messenger = <span class="keyword">new</span> Messenger(messengerHandler);</div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> messenger.getBinder();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端(解释都在注释里)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIPCMessenger</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> TextView tvGet;</div><div class="line">    <span class="keyword">private</span> Messenger mService;</div><div class="line">    <span class="comment">//这个Handler用于处理从服务端反馈来的消息</span></div><div class="line">    <span class="keyword">private</span> Handler MessengerHandler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what)&#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">2</span>:</div><div class="line">                    Bundle bundle = msg.getData();</div><div class="line">                    bundle.setClassLoader(User.class.getClassLoader());</div><div class="line">                    User user = (User) bundle.get(<span class="string">"reply"</span>);</div><div class="line">                    Log.e(<span class="string">"Messenger"</span>,user.toString());</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:<span class="keyword">super</span>.handleMessage(msg);<span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">  	<span class="comment">//这个Messenger用于传递给服务端，从服务端给客户端反馈消息</span></div><div class="line">    <span class="keyword">private</span> Messenger mGetMessenger = <span class="keyword">new</span> Messenger(MessengerHandler);</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.messenger_test_layout);</div><div class="line">        tvGet = (TextView) findViewById(R.id.id_activity_messenger_tv01);</div><div class="line">        init();</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">    <span class="keyword">private</span> ServiceConnection conn = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">      	<span class="comment">//用于绑定远程服务成功后，接受从服务端的onBind()方法返回的IBinder对象</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">            <span class="comment">//根据得到的IBinder对象创建Messenger，该Messenger就相当于服务端创建的Messenger对象，用来向服务端发送消息</span></div><div class="line">            mService = <span class="keyword">new</span> Messenger(service);</div><div class="line">            Message message = Message.obtain();</div><div class="line">            message.what = <span class="number">11</span>;</div><div class="line">            message.replyTo = mGetMessenger;</div><div class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">            bundle.putParcelable(<span class="string">"user"</span>,<span class="keyword">new</span> User(<span class="number">11</span>,<span class="string">"22"</span>,<span class="keyword">true</span>));</div><div class="line">            message.setData(bundle);</div><div class="line">            message.arg1 = <span class="number">555</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mService.send(message);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">      	<span class="comment">//绑定解除后要执行的逻辑写在下面</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MessengerService.class);</div><div class="line">      	<span class="comment">//绑定远程服务</span></div><div class="line">        bindService(intent,conn,BIND_AUTO_CREATE);</div><div class="line">		<span class="comment">//绑定另外一个应用的服务</span></div><div class="line"><span class="comment">//        Intent intent2 = new Intent("andfans.com.andfans_csdn.ser");</span></div><div class="line"><span class="comment">//        intent2.setClassName("andfans.com.andfans_csdn","andfans.com.andfans_csdn.MainActivity$MyService");</span></div><div class="line"><span class="comment">//        bindService(intent2,conn,BIND_AUTO_CREATE);</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        unbindService(conn);</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://oqnfoupsj.bkt.clouddn.com/17-7-23/58731438.jpg" alt=""></p>
<h3 id="使用aidl">使用AIDL</h3>
<p>Messenger只能以串行方式处理客户端发来的消息，如果大量的消息同时发送给服务端，服务端仍然只能一个一个处理，这时使用Messenger就不太合适了，而且Messenger的作用主要是为了传递消息，很多时候我们可能需要跨进程调用服务端的方法，这种情形Messenger就无法做到了，在这种情况下，我们可以使用AIDL来实现跨进程的方法调用。</p>
<h4 id="aidl的实现步骤">AIDL的实现步骤</h4>
<ul>
<li>服务端
<ul>
<li>首先要创建一个Service用来监听客户端的连接请求</li>
<li>然后创建一个AIDL文件，将暴露给客户端的接口在这个AIDL文件中声明</li>
<li>最后在Service中实现这个AIDL接口</li>
</ul>
</li>
<li>客户端
<ul>
<li>首先需要绑定服务端的Service</li>
<li>绑定成功后，将服务端返回的Binder对象转成AIDL接口所属的类型</li>
<li>最后调用AIDL中的方法</li>
</ul>
</li>
<li>AIDL接口的创建</li>
</ul>
<p>AIDL中支持的数据类型：</p>
<ol>
<li>基本数据类型：int、long、char、boolean、double等</li>
<li>String和CharSequence</li>
<li>List：只支持ArrayList，里面的每个元素都必须能够被AIDL文件支持</li>
<li>Map：只支持HashMap，里面的每个元素都必须被AIDL支持，包括key和value</li>
<li>Parcelable：所有实现了Parcelable接口的对象</li>
<li>AIDL：所有AIDL接口本身也可以在AIDL文件中使用</li>
</ol>
<p>在AIDL接口创建时要注意的地方：</p>
<ul>
<li>自定义的AIDL和Parcelable对象必须要显式的import进来，不管他们是否和当前的AIDL文件位于同一个包中</li>
<li>如果AIDL文件中用到了自定义的Parcelable对象，那么必须新建一个和它同名的AIDL文件，并在其中声明它为Parcelable类型</li>
<li>AIDL中除了基本数据类型，其他类型的参数必须标上方向:in(输入型参数)、out(输出型参数)或者inout(输入输出型参数)</li>
<li>AIDL接口中只支持方法，不支持声明静态常量</li>
<li>建议把所有和AIDL相关的类和文件全部放入同一个包中，可以在写客户端时将整个包直接复制过去，不容易出错</li>
<li>AIDL的包结构在服务端和客户端要保持一致，否则会运行出错，因为客户端需要反序列化服务端中和AIDL接口相关的所有类，如果类的完整路径不一样，就无法成功反序列化</li>
</ul>
<p>1.创建一个AIDL接口(BookManager.aidl)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BookManager.aidl</span></div><div class="line"><span class="keyword">package</span> andfans.com.demolist;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"><span class="comment">//AIDL文件中用到的自定义AIDL和Parcelable对象必须显式的import进来</span></div><div class="line"><span class="keyword">import</span> andfans.com.demolist.Book;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.IPC.IOnNewBookArrivedListener;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">BookManager</span> </span>&#123;</div><div class="line">  	<span class="comment">//获取到所有书的信息</span></div><div class="line">    <span class="function">List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span>;</div><div class="line">  	<span class="comment">//对于非基本类型要指定方向in、out、inout</span></div><div class="line">  	<span class="comment">//添加一本书</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addBook</span><span class="params">(in Book book)</span></span>;</div><div class="line">  	<span class="comment">//给客户端注册监听器，这个监听器用于在有新书出现时主动通知所有注册监听的客户端新书的信息</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(IOnNewBookArrivedListener listener)</span></span>;</div><div class="line">  	<span class="comment">//解除监听器的注册</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(IOnNewBookArrivedListener listener)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.为上一个AIDL文件中用到的Parcelable对象Book新建同名的AIDL文件，并在其中声明为Parcelable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// BookManager.aidl</span></div><div class="line"><span class="keyword">package</span> andfans.com.demolist;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line">parcelable Book;</div></pre></td></tr></table></figure>
<p>3.创建AIDL接口IOnNewBookArrivedListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IOnNewBookArrivedListener.aidl</span></div><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"><span class="keyword">import</span> andfans.com.demolist.Book;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IOnNewBookArrivedListener</span> </span>&#123;</div><div class="line">  <span class="comment">//用于给客户端发送新书到来的通知</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">onNewBookArrived</span><span class="params">(in Book newBook)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4.在远程服务端创建Service并且实现AIDL接口BookManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.Services;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Service;</div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.os.Binder;</div><div class="line"><span class="keyword">import</span> android.os.IBinder;</div><div class="line"><span class="keyword">import</span> android.os.RemoteCallbackList;</div><div class="line"><span class="keyword">import</span> android.os.RemoteException;</div><div class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CopyOnWriteArrayList;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicBoolean;</div><div class="line"></div><div class="line"><span class="keyword">import</span> andfans.com.demolist.Book;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.BookManager;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.IPC.IOnNewBookArrivedListener;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AIDLService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"TestIPCAidl"</span>;</div><div class="line">  	<span class="comment">//CopyOnWriteArrayList(不是ArrayList的子类)支持并发读/写，这个类型不是刚刚我们提到的AIDL支持的类型，为什么能够正常工作呢？</span></div><div class="line">  	<span class="comment">//因为AIDL支持的是抽象的List，而List是只是一个接口，当在服务端返回该对象时，在Binder中会按照List的规范去访问数据并最终形成一个新的ArrayList返回给客户端，与此类似的还有ConcurrentHashMap</span></div><div class="line">    <span class="keyword">private</span> CopyOnWriteArrayList&lt;Book&gt; mBookList = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</div><div class="line">  	<span class="comment">/*</span></div><div class="line">  		RemoteCallbackList是系统专门提供的用于删除跨进程listener的接口，支持管理任意AIDL接口，在它内部有一个Map结构专门用来保存所有的AIDL回调，</div><div class="line">  		这个Map的key是IBinder类型，value是Callback类型，在Callback中封装了真正的远程listener。当客户端注册listener的时候，</div><div class="line">  		会把这个listener的信息存入mCallbacks中，IBinder key = listener.asBinder();Callback value = new Callback(listener,cookie);</div><div class="line">  		由此可见，虽然多次跨进程传输客户端的同一个对象会在服务端生成不同的对象，但是这些新生成的对象的底层Binder对象是同一个</div><div class="line">  		RemoteCallbackList当客户端进程终止后，会自动移出客户端所注册的listener，而且在类内部还自动实现了线程同步的功能</div><div class="line">  	*/</div><div class="line">    <span class="keyword">private</span> RemoteCallbackList&lt;IOnNewBookArrivedListener&gt; mListenerList = <span class="keyword">new</span> RemoteCallbackList&lt;&gt;();</div><div class="line">    <span class="keyword">private</span> AtomicBoolean mIsServiceDestory = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">  	<span class="comment">//实现系统自动生成的BookManager.java文件中定义的抽象类Stub中的抽象方法</span></div><div class="line">    <span class="keyword">private</span> Binder binder = <span class="keyword">new</span> BookManager.Stub()&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            <span class="keyword">return</span> mBookList;</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            mBookList.add(book);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(IOnNewBookArrivedListener listener)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            mListenerList.register(listener);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(IOnNewBookArrivedListener listener)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            mListenerList.unregister(listener);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        mBookList.add(<span class="keyword">new</span> Book(<span class="number">1</span>,<span class="string">"JAVA"</span>));</div><div class="line">        mBookList.add(<span class="keyword">new</span> Book(<span class="number">2</span>,<span class="string">"C"</span>));</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> ServiceWorker()).start();</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//当有新书到来时，通知所有注册过监听器的客户端</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onNewBookArrived</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException</span>&#123;</div><div class="line">        mBookList.add(book);</div><div class="line">        Log.e(TAG,<span class="string">"New Book Arrived"</span>+mBookList.size());</div><div class="line">      	<span class="comment">//遍历开始</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mListenerList.beginBroadcast();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">            IOnNewBookArrivedListener listener = mListenerList.getBroadcastItem(i);</div><div class="line">            <span class="keyword">if</span>(listener != <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    listener.onNewBookArrived(book);</div><div class="line">                &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mListenerList.finishBroadcast();</div><div class="line">      <span class="comment">//遍历结束</span></div><div class="line">    &#125;</div><div class="line">  <span class="comment">//每隔5s中添加一本书</span></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceWorker</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">while</span> (!mIsServiceDestory.get())&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">500</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">int</span> BookId = mBookList.size() + <span class="number">1</span>;</div><div class="line">                Book newBook = <span class="keyword">new</span> Book(BookId,<span class="string">"new Book#"</span>+BookId);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    onNewBookArrived(newBook);</div><div class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> binder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5.客户端实现:绑定远程服务，并且将绑定成功后的服务端返回的Binder对象转换成AIDL接口，调用远程方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.content.ComponentName;</div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.content.ServiceConnection;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.os.Handler;</div><div class="line"><span class="keyword">import</span> android.os.IBinder;</div><div class="line"><span class="keyword">import</span> android.os.Message;</div><div class="line"><span class="keyword">import</span> android.os.RemoteException;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> andfans.com.demolist.Book;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.BookManager;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.R;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.Services.AIDLService;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIPCAidl</span> <span class="keyword">extends</span> <span class="title">Activity</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"TestIPCAidl"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_NEW_BOOK_ARRIVED = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> BookManager mBookManager;</div><div class="line">    <span class="keyword">private</span> Handler handler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what)&#123;</div><div class="line">                <span class="keyword">case</span> MESSAGE_NEW_BOOK_ARRIVED:</div><div class="line">                    Log.e(TAG,<span class="string">"receive new book:"</span>+msg.obj);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:<span class="keyword">super</span>.handleMessage(msg);<span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">private</span> ServiceConnection connection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">            BookManager bookManager = BookManager.Stub.asInterface(service);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mBookManager = bookManager;</div><div class="line">              	<span class="comment">//这个方法是在</span></div><div class="line">                List&lt;Book&gt; list = bookManager.getBookList();</div><div class="line">                Log.e(TAG,list.toString());</div><div class="line">                Book newBook = <span class="keyword">new</span> Book(<span class="number">3</span>,<span class="string">"Android"</span>);</div><div class="line">                bookManager.addBook(newBook);</div><div class="line">                List&lt;Book&gt; newList = bookManager.getBookList();</div><div class="line">                Log.e(TAG,newList.toString());</div><div class="line">              	<span class="comment">//客户端注册监听器，这样在添加新书后，服务端会自动通知客户端</span></div><div class="line">                bookManager.registerListener(onNewBookArrivedListener);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">            mBookManager = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> IOnNewBookArrivedListener onNewBookArrivedListener = <span class="keyword">new</span> IOnNewBookArrivedListener.Stub()&#123;</div><div class="line">		<span class="comment">//当有新书时，服务端会回调客户端的该方法</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNewBookArrived</span><span class="params">(Book newBook)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">          	<span class="comment">//因为这个方法是在客户端的Binder线程池中执行的，为了便于UI操作，需要使用Handler进行线程切换</span></div><div class="line">            handler.obtainMessage(MESSAGE_NEW_BOOK_ARRIVED,newBook).sendToTarget();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.aidl_test_layout);</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, AIDLService.class);</div><div class="line">        bindService(intent,connection,BIND_AUTO_CREATE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(mBookManager != <span class="keyword">null</span>&amp;&amp;mBookManager.asBinder().isBinderAlive())&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              	<span class="comment">//在Activity退出前，解除监听器的注册，防止内存泄漏</span></div><div class="line">                mBookManager.unregisterListener(onNewBookArrivedListener);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        unbindService(connection);</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="注意">注意</h4>
<p>客户端调用远程服务的方法，被调用的方法运行在服务端的Binder线程池中，同时客户端会被挂起，这个时候如果服务端方法执行比较耗时，就会导致客户端线程长时间地阻塞，而如果这个客户端线程是UI线程的话，就会导致客户端ANR。由于客户端的onServiceConnected和onServiceDisconnected方法都运行在UI线程中，所以也不可以在它们里面直接调用服务端的耗时方法，由于服务端的方法本身就运行在服务端的Binder线程池中，所以服务端的方法本身就可以执行大量的耗时操作。</p>
<p>同理，当远程服务端需要调用客户端的listener中的方法时，被调用的方法也运行在客户端的Binder连接池中，所以同样不可以在服务端调用客户端的耗时方法</p>
<h4 id="如何处理binder的意外死亡">如何处理Binder的意外死亡？</h4>
<p><strong>方式一:设置死亡代理</strong></p>
<p>Binder是运行在服务端的进程，如果服务端进程由于某种原因异常终止，这个时候客户端到服务端的Binder连接断裂(称之为Binder死亡)，会导致远程调用失败，Binder提供了两个配对方法linkToDeath和unlinkToDeath，通过linkToDeath可以给Binder设置一个死亡代理，当Binder死亡时，我们会收到通知，这个时候我们可以重新发起连接请求从而恢复连接。</p>
<p>给Binder设置死亡代理：</p>
<ul>
<li>声明一个DeathRecipient对象，实现DeathRecipient接口的方法binderDied()，当系统死亡时，系统会回调binderDied方法</li>
<li>在binderDied()中移出之前绑定的binder代理并重新绑定远程服务</li>
<li>在客户端绑定远程服务成功后，给binder设置死亡代理</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> IBinder.DeathRecipient mDeathRecipient = <span class="keyword">new</span> IBinder.DeathRecipient() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span>(mBookManager == <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//移除之前绑定的binder代理</span></div><div class="line">            mBookManager.asBinder().unlinkToDeath(mDeathRecipient,<span class="number">0</span>);</div><div class="line">            mBookManager = <span class="keyword">null</span>;</div><div class="line">            <span class="comment">//重新绑定远程服务</span></div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(mContext, AIDLService.class);</div><div class="line">            bindService(intent,connection,BIND_AUTO_CREATE);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">......</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">  			<span class="comment">//在客户端绑定远程服务成功后，给binder设置死亡代理</span></div><div class="line">            BookManager bookManager = BookManager.Stub.asInterface(service);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                service.linkToDeath(mDeathRecipient,<span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            ......</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p><strong>方式二:在onServiceDisconnected中重连远程服务</strong></p>
<p>这两种方式的区别是：onServiceDisconnected在客户端的UI线程中被回调，而binderDied在客户端的Binder连接池中被回调</p>
<h4 id="如何在aidl中使用权限验证功能">如何在AIDL中使用权限验证功能</h4>
<p>默认情况下，我们的远程服务任何人都可以连接，但这样很不安全，所以我们需要给服务加入权限验证功能，权限验证失败则无法调用服务中的方法。</p>
<ul>
<li>
<p>方式一:在onBind中进行验证，验证不通过就直接返回null，这样验证失败的客户端直接无法绑定服务</p>
<ul>
<li>先在AndroidManifest文件中声明所需权限</li>
<li>在onBind中验证权限</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"andfans.com.demolist.permission.ACCESS_BOOK_SERVICE"</span></span></div><div class="line">        <span class="attr">android:protectionLevel</span>=<span class="string">"normal"</span></div><div class="line">        /&gt;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">       <span class="keyword">int</span> check = checkCallingOrSelfPermission(<span class="string">"andfans.com.demolist.permission.ACCESS_BOOK_SERVICE"</span>);</div><div class="line">       <span class="keyword">if</span>(check == PackageManager.PERMISSION_DENIED)&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> binder;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
</li>
<li>
<p>方式二:在服务端的onTransact方法中进行权限验证，如果验证失败返回false，这样服务端就不会中止执行AIDL中的方法从而达到保护服务端的效果，可以像上面一样使用permission验证，也可以使用Uid和Pid来验证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, android.os.Parcel data, android.os.Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> android.os.RemoteException</span></div><div class="line">&#123;</div><div class="line">        	<span class="comment">//验证权限</span></div><div class="line">	<span class="keyword">int</span> check = checkCallingOrSelfPermission(<span class="string">"andfans.com.demolist.permission.ACCESS_BOOK_SERVICE"</span>);</div><div class="line">          <span class="keyword">if</span>(check == PackageManager.PERMISSION_DENIED)&#123;</div><div class="line">              <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">//验证包名</span></div><div class="line">          String packageName = <span class="keyword">null</span>;</div><div class="line">          String [] packages = getPackageManager().getPackagesForUid(getCallingUid());</div><div class="line">          <span class="keyword">if</span>(packages != <span class="keyword">null</span>&amp;&amp;packages.length &gt; <span class="number">0</span>)&#123;</div><div class="line">              packageName = packages[<span class="number">0</span>];</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span>(!packageName.startsWith(<span class="string">"andfans.com.demolist"</span>))&#123;</div><div class="line">              <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">          &#125;</div><div class="line">        	......</div><div class="line">          <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>除了这里介绍的两种方式，还可以直接给Service指定android:permission属性来进行权限验证。</p>
<h3 id="使用contentprovider">使用ContentProvider</h3>
<p>ContentProvider是Android中提供的专门用于不同应用间进行数据共享的方式，从这一点看来，它天生适合进程间通信，ContentProvider的底层实现同样也是Binder。</p>
<ul>
<li>
<p>创建一个自定义ContentProvider需要实现六个抽象方法：</p>
<ul>
<li>onCreate：表示ContentProvider的创建，一般来说需要做一些初始化工作</li>
<li>getType：用来返回一个Uri请求所对应的MIME类型(媒体类型)</li>
<li>query：查询</li>
<li>update：更新</li>
<li>insert：插入</li>
<li>delete：删除</li>
</ul>
<p>这六个方法中除了onCreate由系统回调并运行在主线程里，其他五个方法均由外界回调并运行在Binder线程池中，update、insert、delete方法都会引起数据源的改变，这个时候需要通过ContentResolver的notifyChange方法来通知外界当前ContentProvider中的数据已经发生改变。要观察一个ContentProvider中的数据改变情况，可以通过ContentResolver的registerContentObserver方法来注册观察者，通过unregisterContentOberver方法来解除观察者</p>
</li>
</ul>
<p>ContentProvider主要以表格形式来组织数据，并且可以包含多个表，除此之外，ContentProvider还支持文件数据，在处理这类数据时，可以在ContentProvider中返回文件的句柄给外界，从而让外界来访问ContentProvider中的文件信息。</p>
<p>1.自定义的ContentProvider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.ContentProvider;</div><div class="line"><span class="keyword">import</span> android.content.ContentValues;</div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.content.UriMatcher;</div><div class="line"><span class="keyword">import</span> android.database.Cursor;</div><div class="line"><span class="keyword">import</span> android.database.sqlite.SQLiteDatabase;</div><div class="line"><span class="keyword">import</span> android.net.Uri;</div><div class="line"><span class="keyword">import</span> android.os.Looper;</div><div class="line"><span class="keyword">import</span> android.os.MessageQueue;</div><div class="line"><span class="keyword">import</span> android.support.annotation.NonNull;</div><div class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">"andfans.com.demolist.IPC.provider"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ContentProvider"</span>;</div><div class="line"></div><div class="line">  	<span class="comment">/*</span></div><div class="line">  		为了知道外界要访问哪个数据表，需要为它们定义单独的Uri和Uri_Code,并通过UriMather将他们关联在一起，这样当外界请求时就可以根据请求的Uri得到对应的Uri_Code，有了Uri_Code我们就知道该对哪个表的数据进行操作了  </div><div class="line">    */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri BOOK_CONTENT_URI = Uri.parse(<span class="string">"content://"</span>+ AUTHORITY +<span class="string">"/book"</span>);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri USER_CONTENT_URI = Uri.parse(<span class="string">"content://"</span>+ AUTHORITY + <span class="string">"/user"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BOOK_URI_CODE = <span class="number">0</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> USER_URI_CODE = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> SQLiteDatabase mDb;</div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UriMatcher uriMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        uriMatcher.addURI(AUTHORITY,<span class="string">"book"</span>,BOOK_URI_CODE);</div><div class="line">        uriMatcher.addURI(AUTHORITY,<span class="string">"user"</span>,USER_URI_CODE);</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//创建</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.e(TAG,<span class="string">"onCreate,current thread:"</span>+Thread.currentThread().getName());</div><div class="line">        mContext = getContext();</div><div class="line">        initProviderData();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initProviderData</span><span class="params">()</span> </span>&#123;</div><div class="line">        mDb = <span class="keyword">new</span> DbOpenHelper(mContext).getWritableDatabase();</div><div class="line">        mDb.execSQL(<span class="string">"delete from "</span>+DbOpenHelper.BOOK_TABLE_NAME);</div><div class="line">        mDb.execSQL(<span class="string">"delete from "</span>+DbOpenHelper.USER_TABLE_NAME);</div><div class="line">        mDb.execSQL(<span class="string">"insert into book values(3,'Android');"</span>);</div><div class="line">        mDb.execSQL(<span class="string">"insert into book values(4,'IOS');"</span>);</div><div class="line">        mDb.execSQL(<span class="string">"insert into book values(5,'Html5');"</span>);</div><div class="line">        mDb.execSQL(<span class="string">"insert into user values(1,'jake',1);"</span>);</div><div class="line">        mDb.execSQL(<span class="string">"insert into user values(2,'jasmine',0);"</span>);</div><div class="line">    &#125;</div><div class="line">  	<span class="comment">//查询</span></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(@NonNull Uri uri, @Nullable String[] projection, @Nullable String selection, @Nullable String[] selectionArgs, @Nullable String sortOrder)</span> </span>&#123;</div><div class="line">        Log.e(TAG,<span class="string">"query,current thread:"</span>+Thread.currentThread().getName());</div><div class="line">        String table = getTableName(uri);</div><div class="line">        <span class="keyword">if</span>(table == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupported URI:"</span>+uri);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mDb.query(table,projection,selection,selectionArgs,<span class="keyword">null</span>,<span class="keyword">null</span>,sortOrder,<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getTableName</span><span class="params">(Uri uri)</span> </span>&#123;</div><div class="line">        String tableName = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">switch</span> (uriMatcher.match(uri))&#123;</div><div class="line">            <span class="keyword">case</span> BOOK_URI_CODE:</div><div class="line">                tableName = DbOpenHelper.BOOK_TABLE_NAME;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> USER_URI_CODE:</div><div class="line">                tableName = DbOpenHelper.USER_TABLE_NAME;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:<span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> tableName;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//返回一个Uri所请求的MIME类型</span></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(@NonNull Uri uri)</span> </span>&#123;</div><div class="line">        Log.e(TAG,<span class="string">"getType"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//插入</span></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(@NonNull Uri uri, @Nullable ContentValues values)</span> </span>&#123;</div><div class="line">        Log.e(TAG,<span class="string">"insert"</span>);</div><div class="line">        String table = getTableName(uri);</div><div class="line">        <span class="keyword">if</span>(table == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupport URI:"</span>+uri);</div><div class="line">        &#125;</div><div class="line">        mDb.insert(table,<span class="keyword">null</span>,values);</div><div class="line">        mContext.getContentResolver().notifyChange(uri,<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">return</span> uri;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//删除</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(@NonNull Uri uri, @Nullable String selection, @Nullable String[] selectionArgs)</span> </span>&#123;</div><div class="line">        Log.e(TAG,<span class="string">"delete"</span>);</div><div class="line">        String table = getTableName(uri);</div><div class="line">        <span class="keyword">if</span>(table == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupport URI:"</span>+uri);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> count = mDb.delete(table,selection,selectionArgs);</div><div class="line">        <span class="keyword">if</span>(count &gt; <span class="number">0</span>)&#123;</div><div class="line">            getContext().getContentResolver().notifyChange(uri,<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> count;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//更新</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(@NonNull Uri uri, @Nullable ContentValues values, @Nullable String selection, @Nullable String[] selectionArgs)</span> </span>&#123;</div><div class="line">        Log.e(TAG,<span class="string">"update"</span>);</div><div class="line">        String table = getTableName(uri);</div><div class="line">        <span class="keyword">if</span>(table == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupport URI:"</span>+uri);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> row = mDb.update(table,values,selection,selectionArgs);</div><div class="line">        <span class="keyword">if</span>(row &gt; <span class="number">0</span>)&#123;</div><div class="line">            getContext().getContentResolver().notifyChange(uri,<span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> row;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.在manifest文件中注册此Provider</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">provider</span></span></div><div class="line">           <span class="attr">android:authorities</span>=<span class="string">"andfans.com.demolist.IPC.provider"</span> </div><div class="line">           <span class="attr">android:name</span>=<span class="string">".IPC.BookProvider"</span></div><div class="line">           <span class="attr">android:process</span>=<span class="string">":a"</span></div><div class="line">           <span class="attr">android:permission</span>=<span class="string">"com.ryg.PROVIDER"</span></div><div class="line">           /&gt;</div></pre></td></tr></table></figure>
<p>android:authorities是ContentProvider的唯一标识，通过这个属性外部应用就可以访问此Provider，因此这个属性值必须是唯一的。</p>
<p>3.在外部应用中访问此Provider</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.content.ContentValues;</div><div class="line"><span class="keyword">import</span> android.database.Cursor;</div><div class="line"><span class="keyword">import</span> android.net.Uri;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"></div><div class="line"><span class="keyword">import</span> andfans.com.demolist.Book;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.Data.User;</div><div class="line"><span class="keyword">import</span> andfans.com.demolist.R;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ProviderActivity"</span>;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.content_provider_test_layout);</div><div class="line">      	<span class="comment">//通过Provider的唯一标识取得ContentProvider的book数据集合的Uri</span></div><div class="line">        Uri bookUri = Uri.parse(<span class="string">"content://andfans.com.demolist.IPC.provider/book"</span>);</div><div class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();</div><div class="line">        values.put(<span class="string">"_id"</span>,<span class="number">6</span>);</div><div class="line">        values.put(<span class="string">"name"</span>,<span class="string">"程序设计的艺术"</span>);</div><div class="line">      	<span class="comment">//将值插入到ContentProvider的数据表中</span></div><div class="line">        getContentResolver().insert(bookUri,values);</div><div class="line">      	<span class="comment">//查询</span></div><div class="line">        Cursor bookCursor = getContentResolver().query(bookUri,<span class="keyword">new</span> String[]&#123;</div><div class="line">                <span class="string">"_id"</span>,<span class="string">"name"</span>&#125;,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">while</span> (bookCursor.moveToNext())&#123;</div><div class="line">            Book book = <span class="keyword">new</span> Book(bookCursor.getInt(<span class="number">0</span>),bookCursor.getString(<span class="number">1</span>));</div><div class="line">            Log.e(TAG,<span class="string">"query book"</span>+book.toString());</div><div class="line">        &#125;</div><div class="line">        bookCursor.close();</div><div class="line">        Uri userUri = Uri.parse(<span class="string">"content://andfans.com.demolist.IPC.provider/user"</span>);</div><div class="line">        Cursor userCursor = getContentResolver().query(userUri,<span class="keyword">new</span> String[]&#123;<span class="string">"_id"</span>,<span class="string">"name"</span>,<span class="string">"sex"</span>&#125;,<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</div><div class="line">        <span class="keyword">while</span> (userCursor.moveToNext())&#123;</div><div class="line">            User user = <span class="keyword">new</span> User(userCursor.getInt(<span class="number">0</span>),userCursor.getString(<span class="number">1</span>),userCursor.getInt(<span class="number">2</span>) == <span class="number">1</span>);</div><div class="line">            Log.e(TAG,<span class="string">"query user:"</span>+user.toString());</div><div class="line">        &#125;</div><div class="line">        userCursor.close();</div><div class="line"><span class="comment">//        getContentResolver().query(uri,null,null,null,null);</span></div><div class="line"><span class="comment">//        getContentResolver().query(uri,null,null,null,null);</span></div><div class="line"><span class="comment">//        getContentResolver().query(uri,null,null,null,null);</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4.借助SQLiteOpenHelper来管理数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.database.sqlite.SQLiteDatabase;</div><div class="line"><span class="keyword">import</span> android.database.sqlite.SQLiteOpenHelper;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.PrintWriter;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DbOpenHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_NAME = <span class="string">"book_provider.db"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BOOK_TABLE_NAME = <span class="string">"book"</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_TABLE_NAME = <span class="string">"user"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DB_VERSION = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String CREATE_BOOK_TABLE = <span class="string">"CREATE TABLE IF NOT EXISTS "</span> + BOOK_TABLE_NAME + <span class="string">"(_id INTEGER PRIMARY KEY,"</span> + <span class="string">"name TEXT)"</span>;</div><div class="line">    <span class="keyword">private</span> String CREATE_USER_TABLE = <span class="string">"CREATE TABLE IF NOT EXISTS "</span></div><div class="line">            + USER_TABLE_NAME + <span class="string">"(_id INTEGER PRIMARY KEY,"</span> + <span class="string">"name TEXT,"</span> + <span class="string">"sex INT)"</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DbOpenHelper</span><span class="params">(Context context)</span></span>&#123;</div><div class="line">        <span class="keyword">super</span>(context,DB_NAME,<span class="keyword">null</span>,DB_VERSION);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</div><div class="line">        db.execSQL(CREATE_BOOK_TABLE);</div><div class="line">        db.execSQL(CREATE_USER_TABLE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="注意">注意</h4>
<p>query、update、insert、delete四大方法是存在多线程并发访问的，因此方法内部要做好线程同步。在这里由于采用的是SQLite，并且只有一个SQLiteDatabase的连接，所以可以正确应对多线程的情况，因为SQLiteDatabase内部对数据库的操作是有同步处理的，但是如果通过多个SQLiteDatabase对象来操作数据库就无法保证线程同步。</p>
<h3 id="使用socket">使用Socket</h3>
<p>Socket也称为&quot;套接字&quot;，分为流式套接字和用户数据报套接字，分别对应于网络的传输控制层的TCP和UDP协议。TCP是面向连接的的协议，提供稳定的双向通信功能，TCP连接建立时需要经过三次握手才能完成，为了提供稳定的数据传输功能，其本身提供了超时重传机制，因此具有很高的稳定性；而UDP是面向无连接的，提供不稳定的单向通信功能，当然UDP也可以实现双向通信功能，在性能上，UDP具有更好的效率，其缺点是无法保证数据一定能正确传输，尤其在网络堵塞的情况下。Socket本身可以支持传输任意字节流。</p>
<p>在使用Socket进行通信时，需要声明网络权限。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>注意不能在主线程中访问网络(Android4.0以后)，会抛出android.os.NetWorkOnMainThreadException</p>
<ul>
<li>服务端设计：当Service启动时，会在线程中建立TCP服务，这里监听的8688端口，然后就可以等待客户端的连接请求，当有客户端连接时，就会产生一个新的Socket，通过每次新创建的Socket就可以分别和不同的客户端通讯了。当客户端断开连接时，服务端这边也会相应的关闭对应的Socket并结束线程(通过判断服务端输入流的返回值来确定，当客户端断开后，服务端这边的输入流就会返回null)</li>
<li>客户端设计：客户端Activity在启动时，会在onCreate中启动一个线程去连接服务端Socket，为了确定能够连接成功，这里采用了超时重连策略，每次连接失败后都会重新尝试建立连接，为了降低重试机制的开销，加入了休眠机制，即每次重试的时间间隔是1000ms</li>
</ul>
<p>服务端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TCPServerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SocketServer"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsServiceDestoryed = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> String[] mDefinedMessages = <span class="keyword">new</span> String[]&#123;</div><div class="line">      <span class="string">"你好啊，哈哈"</span>, <span class="string">"请问你叫什么名字呀？"</span>,<span class="string">"今天北京天气不错，Shy"</span>,<span class="string">"你知道吗?我可是可以和多个人同时聊天的哦"</span></div><div class="line">            ,<span class="string">"给你讲个笑话吧:据说爱笑的人运气都不会太差"</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> TcpServer()).start();</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        mIsServiceDestoryed = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TcpServer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            ServerSocket serverSocket = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">8688</span>);</div><div class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">			<span class="comment">//只要服务端不停止，就持续的接收来自服务端的连接</span></div><div class="line">            <span class="keyword">while</span> (!mIsServiceDestoryed)&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">//接受客户端请求</span></div><div class="line">                    <span class="keyword">final</span> Socket client = serverSocket.accept();</div><div class="line">                    <span class="keyword">new</span> Thread()&#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            <span class="keyword">try</span> &#123;</div><div class="line">                                response(client);</div><div class="line">                            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                e.printStackTrace();</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;.start();</div><div class="line">                &#125;<span class="keyword">catch</span> (IOException e)&#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">(Socket client)</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">        <span class="comment">//用于接收客户端消息</span></div><div class="line">        BufferedReader in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(client.getInputStream()));</div><div class="line">        <span class="comment">//用于向客户端发送消息</span></div><div class="line">        PrintWriter out = <span class="keyword">new</span> PrintWriter(</div><div class="line">                <span class="keyword">new</span> BufferedWriter(</div><div class="line">                        <span class="keyword">new</span> OutputStreamWriter(</div><div class="line">                                client.getOutputStream())),<span class="keyword">true</span>);</div><div class="line">        out.println(<span class="string">"欢迎来到聊天室"</span>);</div><div class="line">        <span class="keyword">while</span> (!mIsServiceDestoryed)&#123;</div><div class="line">            String str = in.readLine();</div><div class="line">            <span class="keyword">if</span>(str == <span class="keyword">null</span>)&#123;</div><div class="line">                <span class="comment">//客户端断开连接</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            Log.e(TAG,<span class="string">"MSG from client:"</span>+str);</div><div class="line">            <span class="keyword">int</span> i = <span class="keyword">new</span> Random().nextInt(mDefinedMessages.length);</div><div class="line">            String msg = mDefinedMessages[i];</div><div class="line">            out.println(msg);</div><div class="line">            Log.e(TAG,<span class="string">"send:"</span>+msg);</div><div class="line">        &#125;</div><div class="line">        Log.e(TAG,<span class="string">"client quit"</span>);</div><div class="line">        in.close();</div><div class="line">        out.close();</div><div class="line">        client.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestIPCSocketClient</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"SocketClient"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_RECEIVE_NEW_MESSAGE = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MESSAGE_SOCKET_CONNECTED = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> Button btSend;</div><div class="line">    <span class="keyword">private</span> EditText editText;</div><div class="line">    <span class="keyword">private</span> PrintWriter printWriter;</div><div class="line">    <span class="keyword">private</span> Socket mClientSocket;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Handler handler = <span class="keyword">new</span> Handler()&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what)&#123;</div><div class="line">                <span class="keyword">case</span> MESSAGE_RECEIVE_NEW_MESSAGE:</div><div class="line">                    String receive = (String) msg.obj;</div><div class="line">                    Log.e(TAG,<span class="string">"receive:"</span>+receive);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MESSAGE_SOCKET_CONNECTED:</div><div class="line">                    Log.e(TAG,<span class="string">"connected!!!"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:<span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"SimpleDateFormat"</span>)</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.socket_test_layout);</div><div class="line">        editText = (EditText) findViewById(R.id.id_activity_socket_ed01);</div><div class="line">        btSend = (Button) findViewById(R.id.id_activity_socket_bt01);</div><div class="line">        btSend.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">final</span> String msg = editText.getText().toString();</div><div class="line">                <span class="keyword">if</span>(!TextUtils.isEmpty(msg)&amp;&amp;printWriter != <span class="keyword">null</span>)&#123;</div><div class="line">                    printWriter.println(msg);</div><div class="line">                    editText.setText(<span class="string">""</span>);</div><div class="line">                    String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"(HH:mm:ss)"</span>).format(<span class="keyword">new</span> Date(System.currentTimeMillis()));</div><div class="line">                    <span class="keyword">final</span> String showedMsg = <span class="string">"self"</span>+time+<span class="string">":"</span>+msg+<span class="string">"\n"</span>;</div><div class="line">                    Log.e(TAG,showedMsg);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, TCPServerService.class);</div><div class="line">        startService(intent);</div><div class="line">        <span class="keyword">new</span> Thread()&#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                connectTCPServer();</div><div class="line">            &#125;</div><div class="line">        &#125;.start();</div><div class="line">    &#125;</div><div class="line">    <span class="meta">@SuppressLint</span>(<span class="string">"SimpleDateFormat"</span>)</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connectTCPServer</span><span class="params">()</span></span>&#123;</div><div class="line">        Socket socket = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">while</span>(socket == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">try</span>&#123;</div><div class="line">                <span class="comment">//连接服务器</span></div><div class="line">                socket = <span class="keyword">new</span> Socket(<span class="string">"localhost"</span>,<span class="number">8688</span>);</div><div class="line">                mClientSocket = socket;</div><div class="line">                <span class="comment">//创建从客户端到服务器传递数据的流</span></div><div class="line">                printWriter = <span class="keyword">new</span> PrintWriter(</div><div class="line">                        <span class="keyword">new</span> BufferedWriter(</div><div class="line">                                <span class="keyword">new</span> OutputStreamWriter(</div><div class="line">                                        socket.getOutputStream())),<span class="keyword">true</span>);</div><div class="line">                handler.sendEmptyMessage(MESSAGE_SOCKET_CONNECTED);</div><div class="line">                Log.e(TAG,<span class="string">"connect server success"</span>);</div><div class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                SystemClock.sleep(<span class="number">1000</span>);</div><div class="line">                Log.e(TAG,<span class="string">"connect failed"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//接受服务端消息</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//用于客户端从服务器端接收数据的流</span></div><div class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(</div><div class="line">                    <span class="keyword">new</span> InputStreamReader(</div><div class="line">                            socket.getInputStream()));</div><div class="line">            <span class="keyword">while</span>(!TestIPCSocketClient.<span class="keyword">this</span>.isFinishing())&#123;</div><div class="line">                String msg = br.readLine();</div><div class="line">                Log.e(TAG,<span class="string">"receive:"</span>+msg);</div><div class="line">                <span class="keyword">if</span>(msg != <span class="keyword">null</span>)&#123;</div><div class="line">                    String time = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"(HH:mm:ss)"</span>).format(<span class="keyword">new</span> Date(System.currentTimeMillis()));</div><div class="line">                    <span class="keyword">final</span> String showedMsg = <span class="string">"server"</span>+time+<span class="string">":"</span>+msg+<span class="string">"\n"</span>;</div><div class="line">                    handler.obtainMessage(MESSAGE_RECEIVE_NEW_MESSAGE,showedMsg).sendToTarget();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Log.e(TAG,<span class="string">"quit...."</span>);</div><div class="line">            printWriter.close();</div><div class="line">            br.close();</div><div class="line">            socket.close();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//在销毁之前，断开与服务端的连接</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mClientSocket != <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mClientSocket.shutdownInput();</div><div class="line">                mClientSocket.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Socket除了可以实现进程间的通信，还可以实现设备间的通讯，前提是这些设备的IP地址互相可见。</p>
<h2 id="binder连接池">Binder连接池</h2>
<p>在开始介绍Binder连接池之前，先来回顾一下AIDL的工作流程：首先创建一个Service和一个AIDL接口，接着创建一个类继承自AIDL接口中的Stub类并实现Stub中的抽象方法，在Service的onBind方法中返回这个类(Stub的实现类)的对象，然后客户端就可以绑定服务端的Service，建立连接后就可以访问远程服务端的方法了</p>
<h3 id="binder连接池的工作机制">Binder连接池的工作机制</h3>
<p>每个业务模块创建自己的AIDL接口并实现此接口，这个时候不同业务模块之间是不能有耦合的，所有实现细节必须要单独开来，然后向服务端提供自己的唯一标识和对应的Binder对象；对与服务端来说，只需要一个Service就可以了，服务端提供一个queryBinder接口，这个接口能够根据业务模块的特征来返回相应的Binder给它们，不同的业务模块拿到所需的Binder对象后就可以进行远程方法调用了。由此可见，Binder连接池的主要作用就是将每个业务模块的Binder请求统一转发到远程Service中去执行，从而避免了重复创建Service的过程。</p>
<p><img src="http://oqnfoupsj.bkt.clouddn.com/17-7-23/91346549.jpg" alt=""></p>
<h3 id="实现binder连接池">实现Binder连接池</h3>
<p>1.为所有业务模块定义aidl接口(这里定义了两个业务模块)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ISecurityCenter.aidl</span></div><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ISecurityCenter</span> </span>&#123;</div><div class="line">  	<span class="comment">//字符加密</span></div><div class="line">    <span class="function">String <span class="title">encrypt</span><span class="params">(String content)</span></span>;</div><div class="line">  	<span class="comment">//字符解密</span></div><div class="line">    <span class="function">String <span class="title">decrypt</span><span class="params">(String password)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ICompute.aidl</span></div><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ICompute</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.实现上面定义的AIDL接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.RemoteException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityCenterImpl</span> <span class="keyword">extends</span> <span class="title">ISecurityCenter</span>.<span class="title">Stub</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span> SECRET_CODE = <span class="string">'^'</span>;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encrypt</span><span class="params">(String content)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        <span class="keyword">char</span> [] chars = content.toCharArray();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chars.length; i++) &#123;</div><div class="line">            chars[i] ^= SECRET_CODE;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(chars);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decrypt</span><span class="params">(String password)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        <span class="keyword">return</span> encrypt(password);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.os.RemoteException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComputeImpl</span> <span class="keyword">extends</span> <span class="title">ICompute</span>.<span class="title">Stub</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        <span class="keyword">return</span> a + b;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.为Binder连接池创建AIDL接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// IBinderPool.aidl</span></div><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="comment">// Declare any non-default types here with import statements</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBinderPool</span> </span>&#123;</div><div class="line">    <span class="function">IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> binderCode)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>4.实现要与Binder连接池绑定的远程Service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Service;</div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.os.Binder;</div><div class="line"><span class="keyword">import</span> android.os.IBinder;</div><div class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPoolService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">  	<span class="comment">//创建一个实现了AIDL接口的类的对象，并且将该对象在与Binder连接池连接之后，返回给Binder连接池，以便Binder连接池可以通过调用queryBinder方法，返回业务模块所需的Binder</span></div><div class="line">    <span class="keyword">private</span> Binder mBinderPool = <span class="keyword">new</span> BinderPool.BinderPoolImpl();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mBinderPool;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5.实现Binder连接池的aidl接口，绑定远程服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.ComponentName;</div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.content.ServiceConnection;</div><div class="line"><span class="keyword">import</span> android.os.IBinder;</div><div class="line"><span class="keyword">import</span> android.os.RemoteException;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.net.PortUnreachableException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPool</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BinderPoolActivity"</span>;</div><div class="line">  	<span class="comment">//定义不同业务模块的标识</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_NONE = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_COMPUTE = <span class="number">0</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BINDER_SECURITY_CENTER = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Context mContext;</div><div class="line">    <span class="keyword">private</span> IBinderPool iBinderPool;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> BinderPool sInstance;</div><div class="line">    <span class="comment">//同步工具类</span></div><div class="line">    <span class="keyword">private</span> CountDownLatch countDownLatch;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BinderPool</span><span class="params">(Context context)</span></span>&#123;</div><div class="line">        mContext = context.getApplicationContext();</div><div class="line">        <span class="comment">//连接服务</span></div><div class="line">        connectBinderPoolService();</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//单例实现Binder连接池</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BinderPool <span class="title">getInstance</span><span class="params">(Context context)</span></span>&#123;</div><div class="line">        <span class="keyword">if</span>(sInstance == <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">synchronized</span> (BinderPool.class)&#123;</div><div class="line">                <span class="keyword">if</span>(sInstance == <span class="keyword">null</span>)&#123;</div><div class="line">                    sInstance = <span class="keyword">new</span> BinderPool(context);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> sInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">connectBinderPoolService</span><span class="params">()</span></span>&#123;</div><div class="line">        countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">        Intent service = <span class="keyword">new</span> Intent(mContext,BinderPoolService.class);</div><div class="line">        mContext.bindService(service,connection,Context.BIND_AUTO_CREATE);</div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">            countDownLatch.await();</div><div class="line">        &#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ServiceConnection connection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">            iBinderPool = IBinderPool.Stub.asInterface(service);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">              	<span class="comment">//设置死亡代理</span></div><div class="line">                iBinderPool.asBinder().linkToDeath(deathRecipient,<span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">            countDownLatch.countDown();</div><div class="line">        &#125;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">//死亡代理</span></div><div class="line">    <span class="keyword">private</span> IBinder.DeathRecipient deathRecipient = <span class="keyword">new</span> IBinder.DeathRecipient() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</div><div class="line">            iBinderPool.asBinder().unlinkToDeath(deathRecipient,<span class="number">0</span>);</div><div class="line">            iBinderPool = <span class="keyword">null</span>;</div><div class="line">            connectBinderPoolService();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">  	<span class="comment">//aidl接口的实现类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPoolImpl</span> <span class="keyword">extends</span> <span class="title">IBinderPool</span>.<span class="title">Stub</span></span>&#123;</div><div class="line">		<span class="comment">//根据不同的业务模块标识选择返回不同的IBinder对象</span></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> binderCode)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            IBinder binder = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">switch</span> (binderCode)&#123;</div><div class="line">                <span class="keyword">case</span> BINDER_SECURITY_CENTER:</div><div class="line">                    binder = <span class="keyword">new</span> SecurityCenterImpl();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> BINDER_COMPUTE:</div><div class="line">                    binder = <span class="keyword">new</span> ComputeImpl();</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:<span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> binder;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">queryBinder</span><span class="params">(<span class="keyword">int</span> binderCode)</span></span>&#123;</div><div class="line">        IBinder binder = <span class="keyword">null</span>;</div><div class="line">        Log.e(TAG,<span class="string">"queryBinder:binderPool ="</span>+(iBinderPool == <span class="keyword">null</span>));</div><div class="line">        <span class="keyword">if</span> (iBinderPool != <span class="keyword">null</span>)&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                binder = iBinderPool.queryBinder(binderCode);</div><div class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> binder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>6.利用Binder连接池完成业务处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> andfans.com.demolist.IPC.BinderPool;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.app.Activity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.os.IBinder;</div><div class="line"><span class="keyword">import</span> android.os.RemoteException;</div><div class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"></div><div class="line"><span class="keyword">import</span> andfans.com.demolist.R;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderPoolActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"BinderPoolActivity"</span>;</div><div class="line">    <span class="keyword">private</span> ISecurityCenter mSecurityCenter;</div><div class="line">    <span class="keyword">private</span> ICompute mCompute;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.binderpool_test_layout);</div><div class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                doWork();</div><div class="line">            &#125;</div><div class="line">        &#125;).start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWork</span><span class="params">()</span></span>&#123;</div><div class="line">      	<span class="comment">//拿到Binder连接池的单例对象</span></div><div class="line">        BinderPool binderPool = BinderPool.getInstance(BinderPoolActivity.<span class="keyword">this</span>);</div><div class="line">      	<span class="comment">//拿到业务要使用的IBinder对象</span></div><div class="line">        IBinder securityBinder = binderPool.queryBinder(BinderPool.BINDER_SECURITY_CENTER);</div><div class="line">      	<span class="comment">//将服务端的Binder对象转换成客户端需要的实现了aidl接口的对象</span></div><div class="line">        mSecurityCenter = SecurityCenterImpl.asInterface(securityBinder);</div><div class="line">        Log.e(TAG,<span class="string">"visit ISecurityCenter"</span>);</div><div class="line">        String msg = <span class="string">"hello world-安卓"</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            String password = mSecurityCenter.encrypt(msg);</div><div class="line">            Log.e(TAG,<span class="string">"doWork:password ="</span>+password);</div><div class="line">            Log.e(TAG,<span class="string">"doWork:content ="</span>+mSecurityCenter.decrypt(password));</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        Log.e(TAG,<span class="string">"visit ICompute"</span>);</div><div class="line">        IBinder computeBinder = binderPool.queryBinder(BinderPool.BINDER_COMPUTE);</div><div class="line">        mCompute = ComputeImpl.asInterface(computeBinder);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Log.e(TAG,<span class="string">"doWork:3+5 ="</span>+mCompute.add(<span class="number">3</span>,<span class="number">5</span>));</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就这样一个借助Binder连接池来实现的一个小Demo就结束了，如果我们想扩展一个新的业务模块该怎么办呢？只需要</p>
<ul>
<li>为新的业务模块创建aidl接口</li>
<li>实现新业务模块的aidl接口</li>
<li>修改BinderPoolImpl中的queryBinder方法，为新业务模块添加一个新的binderCode，并返回新模块对应的Binder对象。</li>
</ul>
<h3 id="注意">注意</h3>
<p>Binder连接池具有断线重连的机制，当远程服务意外终止时，Binder连接池会重新建立连接，这个时候如果业务模块中的Binder调用出现了异常，也需要手动去获取最新的Binder对象</p>
<h2 id="选择合适的ipc方式">选择合适的IPC方式</h2>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">优点</th>
<th style="text-align:center">缺点</th>
<th style="text-align:center">适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Bundle</td>
<td style="text-align:center">简单易用</td>
<td style="text-align:center">只能传输Bundle支持的数据类型</td>
<td style="text-align:center">四大组件间的进程间通信</td>
</tr>
<tr>
<td style="text-align:center">文件共享</td>
<td style="text-align:center">简单易用</td>
<td style="text-align:center">不适合高并发场景，并且无法做到进程间的即时通信</td>
<td style="text-align:center">无并发访问情形，交换简单的数据，实时性不高的场景</td>
</tr>
<tr>
<td style="text-align:center">AIDL</td>
<td style="text-align:center">功能强大，支持一对多并发通信，支持实时通信</td>
<td style="text-align:center">使用稍复杂，需要处理好线程同步</td>
<td style="text-align:center">一对多通信且有RPC需求</td>
</tr>
<tr>
<td style="text-align:center">Messenger</td>
<td style="text-align:center">功能一般，支持一对多串行通信，支持实时通信</td>
<td style="text-align:center">不能很好的处理高并发情形，不支持RPC，数据通过Message进行传输，因此只能传输Bundle支持的数据类型</td>
<td style="text-align:center">低并发的一对多即时通信，无RPC需求，或者无需要返回结果的RPC需求</td>
</tr>
<tr>
<td style="text-align:center">ContentProvider</td>
<td style="text-align:center">在数据源访问方面功能强大，支持一对多并发数据共享，可通过Call方法扩展其他操作</td>
<td style="text-align:center">可以理解为受约束的AIDL，主要提供数据源的CRUD操作</td>
<td style="text-align:center">一对多的进程间数据共享</td>
</tr>
<tr>
<td style="text-align:center">Socket</td>
<td style="text-align:center">功能强大，可以通过网络传输字节流，支持一对多并发实时通信</td>
<td style="text-align:center">实现细节稍繁琐，不支持直接的RPC</td>
<td style="text-align:center">网络数据交换</td>
</tr>
</tbody>
</table>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2017/07/24/Algorithm-21/" data-toggle="tooltip" data-placement="top" title="Algorithm_21">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2017/07/23/Algorithm-20/" data-toggle="tooltip" data-placement="top" title="Algorithm_20">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#概述"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">概述</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ipc的使用场景"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">IPC的使用场景</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#如何查看应用中的进程信息"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">如何查看应用中的进程信息？</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#进程名的指定方式"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">进程名的指定方式</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用多进程会造成的问题"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">使用多进程会造成的问题</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#serializable接口"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Serializable接口</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用serializable来实现序列化"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">使用Serializable来实现序列化</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#serialversionuid的作用"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">serialVersionUID的作用</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#parcelable接口"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Parcelable接口</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#parcelable接口方法解释"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Parcelable接口方法解释</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#parcelable和serializable的区别"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Parcelable和Serializable的区别</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#binder"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">Binder</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#android中ipc的实现方式"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">Android中IPC的实现方式</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用bundle"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">使用Bundle</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用文件共享"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">使用文件共享</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#缺陷"><span class="toc-nav-number">6.2.1.</span> <span class="toc-nav-text">缺陷</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用messenger"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">使用Messenger</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#实现messenger的步骤"><span class="toc-nav-number">6.3.1.</span> <span class="toc-nav-text">实现Messenger的步骤</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用aidl"><span class="toc-nav-number">6.4.</span> <span class="toc-nav-text">使用AIDL</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#aidl的实现步骤"><span class="toc-nav-number">6.4.1.</span> <span class="toc-nav-text">AIDL的实现步骤</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#注意"><span class="toc-nav-number">6.4.2.</span> <span class="toc-nav-text">注意</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#如何处理binder的意外死亡"><span class="toc-nav-number">6.4.3.</span> <span class="toc-nav-text">如何处理Binder的意外死亡？</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#如何在aidl中使用权限验证功能"><span class="toc-nav-number">6.4.4.</span> <span class="toc-nav-text">如何在AIDL中使用权限验证功能</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用contentprovider"><span class="toc-nav-number">6.5.</span> <span class="toc-nav-text">使用ContentProvider</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#注意"><span class="toc-nav-number">6.5.1.</span> <span class="toc-nav-text">注意</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用socket"><span class="toc-nav-number">6.6.</span> <span class="toc-nav-text">使用Socket</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#binder连接池"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">Binder连接池</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#binder连接池的工作机制"><span class="toc-nav-number">7.1.</span> <span class="toc-nav-text">Binder连接池的工作机制</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#实现binder连接池"><span class="toc-nav-number">7.2.</span> <span class="toc-nav-text">实现Binder连接池</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#注意"><span class="toc-nav-number">7.3.</span> <span class="toc-nav-text">注意</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#选择合适的ipc方式"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">选择合适的IPC方式</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                          <a class="tag" href="/tags/#IPC" title="IPC">IPC</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://huangxuan.me" target="_blank">Hux Blog</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "your-disqus-ID";
    var disqus_identifier = "http://andfanswzp.pw/2017/07/23/IPC浅析/";
    var disqus_url = "http://andfanswzp.pw/2017/07/23/IPC浅析/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/flyings-sky">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Andfans 2017 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://andfanswzp.pw/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="http://andfanswzp.pw/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
